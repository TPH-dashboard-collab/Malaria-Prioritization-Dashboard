}
# indicator
if (ind_input=="Tous les cas"){
ind<-"c"
}
if (ind_input=="Cas simples"){
ind<-"uncomp"
}
if (ind_input=="Cas graves"){
ind<-"severe"
}
if (ind_input=="Décès"){
ind<-"d"
}
# age group
article_age<-" chez les "
if (age_input=="0 à 1 an"){
age_group<-"0to1"
}
if (age_input=="1 à 5 ans"){
age_group<-"1to5"
}
if (age_input=="0 à 5 ans"){
age_group<-"0to5"
}
if (age_input=="Tous âges confondus"){
age_group<-"All"
article_age<-" "
}
if (int_input=="Moustiquaires bi-traitées"){
picked_data <- get(paste0("averted",level,"_PBOstandard"))
int_input_l <- "moustiquaires bi-traitées en 2026 par rapport aux standard"
}else{
picked_data <- get(paste0("averted",level))
int_input_l <- paste0(int_input," par rapport aux interventions courantes")
}
if (unit_input=="absolus"){
data_plot=picked_data %>%
filter(age==age_group) %>%
mutate(mean=!!sym(paste0(ind,"a.tot.mean")),
min=!!sym(paste0(ind,"a.tot.inf")),
max=!!sym(paste0(ind,"a.tot.sup"))) %>%
filter(scenario==paste0("plan_",int),!is.na(!!sym(level)),mean>0,!!sym(int))
ylab <- paste0(ind_input,article_age,tolower(age_input),
"évités entre 2024 et 2026\npar ",article," ",int_input_l)
}
if (unit_input=="par personne protégée"){
data_plot=picked_data %>%
filter(age==age_group) %>%
mutate(pop_targeted=prop*pop_All) %>%
mutate(mean=!!sym(paste0(ind,"a.tot.mean"))/pop_targeted*10^3,
min=!!sym(paste0(ind,"a.tot.inf"))/pop_targeted*10^3,
max=!!sym(paste0(ind,"a.tot.sup"))/pop_targeted*10^3) %>%
filter(scenario==paste0("plan_",int),!is.na(!!sym(level)),mean>0,!!sym(int))
ylab=paste0(ind_input,article_age,tolower(age_input),
" évités entre 2024 et 2026\npar",article," ",int_input_l,"\n",
"pour 1000 personnes ciblées")
}
if (unit_input=="par euro dépensé"){
data_plot=picked_data %>%
filter(age==age_group) %>%
mutate(pop_targeted=prop*pop_All) %>%
mutate(cost_total=pop_targeted*cost) %>%
mutate(mean=!!sym(paste0(ind,"a.tot.mean"))/cost_total*10^3,
min=!!sym(paste0(ind,"a.tot.inf"))/cost_total*10^3,
max=!!sym(paste0(ind,"a.tot.sup"))/cost_total*10^3) %>%
filter(scenario==paste0("plan_",int),!is.na(!!sym(level)),mean>0,!!sym(int))
ylab=paste0(ind_input,article_age,tolower(age_input),
" évités entre 2024 et 2026\npar",article," ",int_input_l,"\n",
"pour 1000 euros")
}
data_plot <- data_plot %>%
ungroup() %>%
mutate(rank=rank(-mean))
b<-floor(max(data_plot$rank)/5)
data_plot <- data_plot %>%
mutate(rankbreaks=ceiling(rank/b)) %>%
mutate(rankbreaks=ifelse(rankbreaks>5,5,rankbreaks))
return(list(d=data_plot,y=ylab,cost=cost,proportion=prop))
}
#OrderGeo("Communes","CPP","Cas graves","0 à 5 ans","absolus")$d
palRanks <- c('#780116','#c32f27','#d8572a','#db7c26','#f7b538')
renderLeaflet({
result<-OrderGeo(input$level_input,input$int_input,input$ind_input,input$age_input,input$unit_input)$d %>%
select(-Admin1)
if(input$level_input=="Communes"){
ranking <- raster::merge( Admin2_gSimplify, result,
by = "sub" )
leaflet() %>%
addProviderTiles(providers$CartoDB) %>%
addPolygons(data = sf::st_as_sf(ranking)
, label = ~firstup(sub)
, group = "nc"
, color = "white"
, fillColor =  ~colorFactor(palRanks, domain = NULL,na.color = "lightgrey")(rankbreaks)
, opacity = 1
, fillOpacity = 1
, weight = 1
,  popup = paste0(firstup(ranking$sub), " - "
,ranking$rank
)
) %>%
addResetMapButton()%>%
addSearchFeatures(
targetGroups  = "nc",
options = searchFeaturesOptions(zoom = 5, openPopup = TRUE)) #%>%
# addLegend("bottomright"
#                    , pal = palScenLabels, values = unique(plansSelectedMap()$scenLabel)
#                    , title = "Interventions"
#                    , opacity = 1
#                    )
}else{
ranking <- raster::merge( AdminZS_gSimplify, result,
by = c("ZS","ZS_CHAI","nameZS") )
leaflet() %>%
addProviderTiles(providers$CartoDB) %>%
addPolygons(data = sf::st_as_sf(ranking)
, label = ~ZS
, group = "nc"
, color = "white"
, fillColor =  ~colorFactor(palRanks, domain = NULL,na.color = "lightgrey")(rankbreaks)
, opacity = 1
, fillOpacity = 1
, weight = 1
,  popup = paste0(firstup(ranking$nameZS), " : "
,ranking$rank
)
) %>%
addResetMapButton()%>%
addSearchFeatures(
targetGroups  = "nc",
options = searchFeaturesOptions(zoom = 5, openPopup = TRUE))
}
}
)
Barplot = reactive({
r=OrderGeo(input$level_input,input$int_input,input$ind_input,input$age_input,input$unit_input)
data_plot <- r$d
ylab <- r$y
if(input$level_input=="Zones sanitaires"){
g<-ggplot(data_plot,
aes(x=reorder(ZS,-mean),y=mean,ymin=min,ymax=max,
fill=as.factor(rankbreaks),
color=as.factor(rankbreaks),
text=paste0(nameZS,
#"<br>Enfants ciblés : ",round(pop_targeted),
"<br>",round(mean,2),
" (",round(min,2)," - ",round(max,2),")")))+
labs(x="Zone sanitaire",y=ylab,color="Département",fill="Département")
}else{
g<-ggplot(data_plot,
aes(x=reorder(firstup(sub),-mean),y=mean,ymin=min,ymax=max,
fill=as.factor(rankbreaks),
color=as.factor(rankbreaks),
text=paste0(firstup(sub),
#"<br>Enfants ciblés : ",round(pop_targeted),
"<br>",round(mean,2),
" (",round(min,2)," - ",round(max,2),")")))+
labs(x="Commune",y=ylab,color="Département",fill="Département")
}
g<-g+
geom_col(alpha=.85)+
geom_errorbar(width=.3)+
scale_color_manual(values=palRanks)+
scale_fill_manual(values=palRanks)+
theme_minimal()+
theme(axis.text.x=element_text(angle = 45),legend.position = "none")
p<-ggplotly(g,tooltip = "text") %>%
layout(yaxis=list(title=list(font=list(size=10))))
return(p)
})
renderPlotly(Barplot())
BarplotCost = reactive({
r=OrderGeo(input$level_input,input$int_input,input$ind_input,input$age_input,input$unit_input)
data_plot <- r$d
cost <- r$cost
prop <- r$proportion
data_cost <- data_plot %>%
arrange(-mean) %>%
ungroup() %>%
mutate(pop_targeted=prop*pop_All) %>%
mutate(cost_total=pop_targeted*cost) %>%
mutate(cum_cost=cumsum(cost_total))
if(input$level_input=="Zones sanitaires"){
data_cost$ZS_plus <- paste0("+ ",data_cost$ZS)
data_cost$ZS_plus[1] <- data_cost$ZS[1]
data_cost$nameZS_plus <- paste0("+ ",data_cost$nameZS)
data_cost$nameZS_plus[1] <- data_cost$nameZS[1]
g<-ggplot(data_cost,
aes(y=reorder(ZS_plus,mean),x=cum_cost/10^6,fill=as.factor(rankbreaks),
text=paste0(nameZS_plus,
#"<br>Enfants ciblés : ",round(pop_targeted),
"<br>",prettyNum(round(cum_cost),big.mark = " ", preserve.width = "none"),"€")))+
labs(y="Zone sanitaire",x="Coût cumulé en millions d'euros",fill="Département")
}else{
data_cost$sub_plus <- paste0("+ ",firstup(data_cost$sub))
data_cost$sub_plus[1] <- firstup(data_cost$sub[1])
g<-ggplot(data_cost,
aes(y=reorder(sub_plus,mean),x=cum_cost/10^6,fill=as.factor(rankbreaks),
text=paste0(sub_plus,
#"<br>Enfants ciblés : ",round(pop_targeted),
"<br>",prettyNum(round(cum_cost),big.mark = " ", preserve.width = "none"),"€")))+
labs(y="Commune",x="Coût cumulé en millions d'euros",fill="Département")
}
g<-g+geom_col(alpha=.85)+
scale_fill_manual(values=palRanks)+
theme_minimal()+
theme(axis.text.x=element_text(angle = 45),legend.position = "none")
p<-ggplotly(g,tooltip = "text") %>%
layout(yaxis=list(title=list(font=list(size=10))))
return(p)
})
renderPlotly(BarplotCost())
selectizeInput("opt_commune_input", "Commune", unique(averted_cases$sub), selected = "bassila", multiple = FALSE,
options = NULL)
radioButtons("opt_ind_input", label = "Indicateur",
choices = c("Tous les cas","Cas simples", "Cas graves", "Décès"),
selected="Tous les cas")
radioButtons("opt_age_input", label = "Tranche d'âge",
choices = c("Tous âges confondus","0 à 1 an","1 à 5 ans", "0 à 5 ans"),
selected="Tous âges confondus")
OrderCost <- function(opt_commune_input,opt_ind_input,opt_age_input){
#administrative level
# indicator
if (opt_ind_input=="Tous les cas"){
ind<-"c"
ind_legend<-"cas"
}
if (opt_ind_input=="Cas simples"){
ind<-"uncomp"
ind_legend <- "cas simple"
}
if (opt_ind_input=="Cas graves"){
ind<-"severe"
ind_legend <- "cas grave"
}
if (opt_ind_input=="Décès"){
ind<-"d"
ind_legend <- "décès"
}
# age group
article_age<-" chez les "
if (opt_age_input=="0 à 1 an"){
age_group<-"0to1"
}
if (opt_age_input=="1 à 5 ans"){
age_group<-"1to5"
}
if (opt_age_input=="0 à 5 ans"){
age_group<-"0to5"
}
if (opt_age_input=="Tous âges confondus"){
age_group<-"All"
article_age<-" "
}
data_plot=avertedsub %>%
filter(age==age_group,sub==opt_commune_input) %>%
mutate(prop=case_when(scenario=="plan_SMC"~.152,
scenario=="plan_PMC"~.046,
TRUE~1)) %>%
left_join(pop %>% filter(year==2026) %>% rename(pop_2026="pop_All")) %>%
mutate(cost=case_when(scenario=="plan_SMC"~input$cost_SMC,
scenario=="plan_PMC"~input$cost_PMC,
scenario=="plan_IRS"~input$cost_IRS,
scenario=="plan_PBO"~(input$cost_PBO-input$cost_standard))) %>%
mutate(pop_All=ifelse(scenario=="plan_PBO",pop_2026,pop_All)) %>%
mutate(pop_targeted=prop*pop_All) %>%
mutate(cost_total=pop_targeted*cost) %>%
mutate(mean=cost_total/!!sym(paste0(ind,"a.tot.mean")),
max=cost_total/!!sym(paste0(ind,"a.tot.inf")),
min=cost_total/!!sym(paste0(ind,"a.tot.sup"))) %>%
filter(!is.na(mean),mean<Inf)
ylab=paste0("Coût d'un ",ind_legend,article_age,tolower(opt_age_input),
"\névité entre 2024 et 2026 (en euros)")
return(list(d=data_plot,y=ylab))
}
eligibleSMC <- eligible %>% filter(SMC) %>% pull(sub)
eligiblePMC <- eligible %>% filter(PMC) %>% pull(sub)
eligibleIRS <- eligible %>% filter(IRS) %>% pull(sub)
eligiblePBO <- eligible %>% pull(sub)
BarplotCostPerCase = reactive({
r<-OrderCost(input$opt_commune_input,input$opt_ind_input,input$opt_age_input)
data_plot <- r$d %>%
filter(!(scenario=="plan_SMC"&!sub%in%eligibleSMC)) %>%
filter(!(scenario=="plan_PMC"&!sub%in%eligiblePMC)) %>%
filter(!(scenario=="plan_IRS"&!sub%in%eligibleIRS)) %>%
filter(!(scenario=="plan_PBO"&!sub%in%eligiblePBO)) %>%
mutate(scenario=case_when(scenario=="plan_SMC"~"CPS",
scenario=="plan_PMC"~"CPP",
scenario=="plan_IRS"~"PID",
scenario=="plan_PBO"~"Moustiquaires bi-traitées",
TRUE~"autre"))
ylab <- r$y
g<-ggplot(data_plot,
aes(x=reorder(scenario,mean),y=mean,ymin=min,ymax=max,text=paste0(round(mean)," (",round(min)," - ",round(max),")")))+
geom_col(alpha=.85)+
geom_errorbar()+
labs(y=ylab,x="Intervention")+
theme_minimal()
p<-ggplotly(g,tooltip = "text") %>%
layout(yaxis=list(title=list(font=list(size=10))))
return(p)
})
renderPlotly(BarplotCostPerCase())
knitr::opts_chunk$set(echo = FALSE)
rm(list=ls())
library(tidyverse)
#library(rgdal)
library(sf)
library(terra)
library(leaflet)
library(leaflet.extras)
library(DT)
#library(rhandsontable)
library(data.table)
library(leaflet)
library(plotly)
library(RColorBrewer)
library(shiny)
firstup <- function(x) {
substr(x, 1, 1) <- toupper( substr(x, 1, 1) )
x
}
### from Tatiana
# FUNCTIONS AGGR TIME SERIES ----------------------------------------------
## PREVALENCE
computeAggrTimeSeriesPR <- function(allSims
, pr_col = "PR"
, level_aggr = "setting"
, pop_col = "totPop"
, eir_col = "EIR"
, fut_cols = "fut"
, EIR_names = c("low","middle","high")
, id_cols = c("sub", "setting", "seed", "year", "age", pop_col, fut_cols)){
simsSub = allSims %>% pivot_wider(names_from = eir_col
, values_from = pr_col
, id_cols = id_cols
, names_expand = TRUE) %>%
group_by(across(id_cols[id_cols != "seed"])) %>%
mutate(  ind_inf = min(get(EIR_names[1]), get(EIR_names[2]), get(EIR_names[3]))
, ind_sup = max(get(EIR_names[1]), get(EIR_names[2]), get(EIR_names[3]))
, ind_mean = mean(middle))
if (level_aggr == "sub"){
aggrDF = simsSub %>% group_by(across(id_cols[!(id_cols %in% c("seed", "sub", pop_col))])) %>%
dplyr::summarise(ind_mean = weighted.mean(ind_mean, get(pop_col))
, ind_inf = weighted.mean(ind_inf, get(pop_col))
, ind_sup = weighted.mean(ind_sup, get(pop_col)))
}
if (level_aggr == "setting"){
aggrDF = simsSub %>% group_by(across(id_cols[!(id_cols %in% c("seed", "sub", pop_col))])) %>%
dplyr::summarise(ind_mean = weighted.mean(ind_mean, get(pop_col))
, ind_inf = weighted.mean(ind_inf, get(pop_col))
, ind_sup = weighted.mean(ind_sup, get(pop_col)))
}
if (level_aggr == "national"){
aggrDF = simsSub %>% group_by(across(id_cols[!(id_cols %in% c("seed", "sub", "setting",pop_col))])) %>%
dplyr::summarise(ind_mean = weighted.mean(ind_mean, get(pop_col))
, ind_inf = weighted.mean(ind_inf, get(pop_col))
, ind_sup = weighted.mean(ind_sup, get(pop_col)))
}
return(list(simsSub, aggrDF))
}
# casesAverted.sumAcrossYears <- function(allSims
#                                         , cases_col = "cases"
#                                         , level_aggr = "setting"
#                                         , eir_col = "EIR"
#                                         , EIR_names = c("low","middle","high")
#                                         , fut_cols = "fut"
#                                         , counterfactual = "BaU"
#                                         , year_start = 2023
#                                         , year_end = 2025){
#
#
#
#   subSims = allSims %>% group_by(across(c("sub","ZS", "setting", "seed", "age",  fut_cols, eir_col))) %>%
#     filter(year %in% seq(year_start, year_end)) %>%
#     dplyr::summarise(cases.all = sum(get(cases_col))) %>%
#     group_by(across(c("sub","ZS", "setting", "seed", eir_col))) %>%
#     mutate(ca = cases.all[get(fut_cols) == counterfactual] - cases.all) %>%
#     #keep only fut 2 (otherwise, duplicated rows)
#     #filter(get(fut_cols) == scenario) %>%
#     #select the extremes and take mean of middle
#     pivot_wider(names_from = eir_col, values_from = c(ca), id_cols = c("sub", "ZS","setting", fut_cols, "seed", "age")) %>%
#     group_by(across(c("sub", "ZS","setting", "age", fut_cols))) %>%
#     dplyr::summarise(ca.mean = mean(get(EIR_names[2]))
#                      , ca.sup = max(get(EIR_names[3]), get(EIR_names[2]), get(EIR_names[1]))
#                      , ca.inf = min(get(EIR_names[3]), get(EIR_names[2]), get(EIR_names[1])))
#
#   if (level_aggr == "sub"){
#     aggrDF = subSims
#   }
#   if (level_aggr == "setting"){
#     #aggregate at setting level by summing all cases averted
#     aggrDF = subSims %>% group_by(across(c("setting", age, fut_cols))) %>%
#       dplyr::summarise(ca.tot.mean = sum(ca.mean)
#                        , ca.tot.sup = sum(ca.sup)
#                        , ca.tot.inf = sum(ca.inf))
#   }
#   if (level_aggr == "ZS"){
#     #aggregate at ZS level by summing all cases averted
#     aggrDF = subSims %>% group_by(across(c("ZS", age, fut_cols))) %>%
#       dplyr::summarise(ca.tot.mean = sum(ca.mean)
#                        , ca.tot.sup = sum(ca.sup)
#                        , ca.tot.inf = sum(ca.inf))
#   }
#   if(level_aggr == "national"){
#     #aggregate at setting level by summing all cases averted
#     aggrDF = subSims %>% group_by(across(c("age", fut_cols))) %>%
#       dplyr::summarise(ca.tot.mean = sum(ca.mean)
#                        , ca.tot.sup = sum(ca.sup)
#                        , ca.tot.inf = sum(ca.inf))
#   }
#   return(aggrDF)
# }
percentReductionPR.acrossScenarios <- function(allSims
, pr_col = "PR"
, level_aggr = "setting"
, pop_col = "totPop"
, eir_col = "EIR"
, EIR_names = c("low","middle","high")
, fut_cols = "fut"
, comparison_year = 2025
, counterfactual = "BaU"
, id_cols = c("sub", "setting", "seed", "year", "age", pop_col, fut_cols)){
simsSub =  allSims %>% pivot_wider(names_from = eir_col
, values_from = pr_col
, id_cols = id_cols
, names_expand = TRUE)
if (level_aggr == "setting"){
aggrDF = simsSub %>% group_by(across(c("setting", "year", fut_cols, "seed", "age"))) %>%
dplyr::summarise(PR_mean = weighted.mean(get(EIR_names[2]), get(pop_col))
, PR_inf = weighted.mean(get(EIR_names[1]), get(pop_col))
, PR_sup = weighted.mean(get(EIR_names[3]), get(pop_col))) %>%
filter(year %in% c(comparison_year)) %>%
group_by(setting, seed, age) %>%
mutate(diff.mean= 100*(1-PR_mean/PR_mean[get(fut_cols) == counterfactual]),
diff.inf= 100*(1-PR_inf/PR_inf[get(fut_cols) == counterfactual]),
diff.sup= 100*(1-PR_sup/PR_sup[get(fut_cols) == counterfactual])) %>%
group_by(across(c("setting", fut_cols, 'age'))) %>%
summarise(diff.mean.Aggr=mean(diff.mean),
diff.inf.Aggr=min(diff.inf, diff.mean, diff.sup),
diff.sup.Aggr=max(diff.inf, diff.mean, diff.sup))
}
if (level_aggr == "national"){
aggrDF = simsSub %>% group_by(across(c("year", fut_cols, "seed", "age"))) %>%
dplyr::summarise(PR_mean = weighted.mean(get(EIR_names[2]), get(pop_col))
, PR_inf = weighted.mean(get(EIR_names[1]), get(pop_col))
, PR_sup = weighted.mean(get(EIR_names[3]), get(pop_col))) %>%
filter(year %in% c(comparison_year)) %>%
group_by(seed, age) %>%
mutate(diff.mean= 100*(1-PR_mean/PR_mean[get(fut_cols) == counterfactual]),
diff.inf= 100*(1-PR_inf/PR_inf[get(fut_cols) == counterfactual]),
diff.sup= 100*(1-PR_sup/PR_sup[get(fut_cols) == counterfactual])) %>%
group_by(across(c(fut_cols, 'age'))) %>%
summarise(diff.mean.Aggr=mean(diff.mean),
diff.inf.Aggr=min(diff.inf, diff.mean, diff.sup),
diff.sup.Aggr=max(diff.inf, diff.mean, diff.sup))
}
return(aggrDF)
}
setwd(dirname(rstudioapi::getSourceEditorContext()$path))
averted_cases <- readRDS("./Data_prio/averted_popDPAF.rds")
ZScommune <- readRDS("./Data_prio/correpondence_ZS_commune.rds")
# allow for Bembereke and Sinende to switch from PMC pilot to SMC in 2026
eligible <- readRDS("./Data_prio/eligible_communes.rds") %>%
mutate(SMC=ifelse(sub%in%c("bembereke","sinende"),TRUE,SMC))
avertedZS <- readRDS("./Data_prio/averted_ZS_popDPAF.rds") %>%
left_join(eligible %>% select(-sub) %>% distinct())
avertedsub <- readRDS("./Data_prio/averted_sub_popDPAF.rds") %>%
left_join(eligible)
avertedZS_PBOstandard <- readRDS("./Data_prio/averted_PBOtostandard2026_ZS_popDPAF.rds") %>%
left_join(eligible %>% select(-sub) %>% distinct())
avertedsub_PBOstandard <- readRDS("./Data_prio/averted_PBOtostandard2026_sub_popDPAF.rds") %>%
left_join(eligible)
pop <- readRDS("./Data_prio/popDPAF.rds")
cases <- readRDS("./Data_prio/simple_severe_popDPAF.rds")
PfPR <- readRDS("./Data_prio/PfPR0to5.rds")
#Admin2 <- file.path("./Data_prio/shapefiles/communes.shp") %>% readOGR(verbose = FALSE)
#New:
Admin2 <- sf::st_read(
"./Data_prio/shapefiles/communes.shp",
quiet = TRUE
)
#this things to make shapefile lighter
#Admin2_rg = rgeos::gSimplify(Admin2, tol = 0.02, topologyPreserve = TRUE)
#New:
#Admin2_rg = sf::st_simplify(Admin2, dTolerance = 0.02, preserveTopology = TRUE)
# Desativar s2, corrigir geometria e simplificar
sf::sf_use_s2(FALSE)
Admin2_valid <- sf::st_make_valid(Admin2)
Admin2_rg <- sf::st_simplify(Admin2_valid, dTolerance = 0.02, preserveTopology = TRUE)
sf::sf_use_s2(TRUE)
#Admin2_df <- Admin2@data %>% mutate(sub=tolower(NAME1_),
#                                    Admin1=case_when(Admn1_N=="Kouffo" ~ "Couffo",
#                                                     Admn1_N=="Atakora" ~ "Atacora",
#                                                     Admn1_N=="OuÃ©mÃ©" ~ "Oueme",
#                                                    TRUE ~ Admn1_N))
#New:
Admin2_df <- Admin2 %>%
mutate( sub = tolower(NAME1_), Admin1 = case_when(
Admn1_N == "Kouffo"  ~ "Couffo",
Admn1_N == "Atacora" ~ "Atacora",
Admn1_N == "Ouémé"   ~ "Oueme",
TRUE ~ Admn1_N
))
#Admin2_gSimplify <- sp::SpatialPolygonsDataFrame(Admin2_rg, Admin2_df)
#New:
# Admin2_rg já é um objeto sf completo com dados e geometria
# Não precisa fazer nada mais!
# Se precisar renomear:
Admin2_gSimplify <- Admin2_rg %>%
left_join(Admin2_df, by = "sub")
