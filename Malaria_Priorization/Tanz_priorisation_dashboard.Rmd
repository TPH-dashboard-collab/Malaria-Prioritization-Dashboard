---
title: "Requête au Fonds mondial"
output:
  flexdashboard::flex_dashboard:
    theme: 
      version: 4
      bootswatch: minty
    orientation: columns
    vertical_layout: scroll
    source_code: embed
    logo: logosmall.png
runtime: shiny
resource_files:
- Data_prio/shapefiles/communes.shx
- Data_prio/shapefiles/communes.dbf
- Data_prio/shapefiles/communes.prj
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r LOAD LIBRARIES}
rm(list=ls())
library(tidyverse)
#library(rgdal)
library(sf)
library(terra)
library(leaflet)
library(leaflet.extras)
library(DT)
#library(rhandsontable)
library(data.table)
library(leaflet)
library(plotly)
library(RColorBrewer)
library(shiny)
```

```{r}
firstup <- function(x) {
  substr(x, 1, 1) <- toupper( substr(x, 1, 1) )
  x
}

### from Tatiana

# FUNCTIONS AGGR TIME SERIES ----------------------------------------------
## PREVALENCE
computeAggrTimeSeriesPR <- function(allSims
                                    , pr_col = "PR"
                                    , level_aggr = "setting"
                                    , pop_col = "totPop"
                                    , eir_col = "EIR"
                                    , fut_cols = "fut"
                                    , EIR_names = c("low","middle","high")
                                    , id_cols = c("sub", "setting", "seed", "year", "age", pop_col, fut_cols)){
  
  
  
  simsSub = allSims %>% pivot_wider(names_from = eir_col
                                    , values_from = pr_col
                                    , id_cols = id_cols
                                    , names_expand = TRUE) %>%
    group_by(across(id_cols[id_cols != "seed"])) %>% 
    mutate(  ind_inf = min(get(EIR_names[1]), get(EIR_names[2]), get(EIR_names[3]))
             , ind_sup = max(get(EIR_names[1]), get(EIR_names[2]), get(EIR_names[3]))
             , ind_mean = mean(middle))
  if (level_aggr == "sub"){
    aggrDF = simsSub %>% group_by(across(id_cols[!(id_cols %in% c("seed", "sub", pop_col))])) %>%
      dplyr::summarise(ind_mean = weighted.mean(ind_mean, get(pop_col))
                       , ind_inf = weighted.mean(ind_inf, get(pop_col))
                       , ind_sup = weighted.mean(ind_sup, get(pop_col)))  
  } 
  if (level_aggr == "setting"){
    aggrDF = simsSub %>% group_by(across(id_cols[!(id_cols %in% c("seed", "sub", pop_col))])) %>%
      dplyr::summarise(ind_mean = weighted.mean(ind_mean, get(pop_col))
                       , ind_inf = weighted.mean(ind_inf, get(pop_col))
                       , ind_sup = weighted.mean(ind_sup, get(pop_col)))  
  } 
  if (level_aggr == "national"){
    aggrDF = simsSub %>% group_by(across(id_cols[!(id_cols %in% c("seed", "sub", "setting",pop_col))])) %>%
      dplyr::summarise(ind_mean = weighted.mean(ind_mean, get(pop_col))
                       , ind_inf = weighted.mean(ind_inf, get(pop_col))
                       , ind_sup = weighted.mean(ind_sup, get(pop_col)))  
  }  
  return(list(simsSub, aggrDF))
}

# casesAverted.sumAcrossYears <- function(allSims
#                                         , cases_col = "cases"
#                                         , level_aggr = "setting"
#                                         , eir_col = "EIR"
#                                         , EIR_names = c("low","middle","high")
#                                         , fut_cols = "fut"
#                                         , counterfactual = "BaU"
#                                         , year_start = 2023
#                                         , year_end = 2025){
#   
#   
#   
#   subSims = allSims %>% group_by(across(c("sub","ZS", "setting", "seed", "age",  fut_cols, eir_col))) %>%
#     filter(year %in% seq(year_start, year_end)) %>%
#     dplyr::summarise(cases.all = sum(get(cases_col))) %>%
#     group_by(across(c("sub","ZS", "setting", "seed", eir_col))) %>%
#     mutate(ca = cases.all[get(fut_cols) == counterfactual] - cases.all) %>%
#     #keep only fut 2 (otherwise, duplicated rows)
#     #filter(get(fut_cols) == scenario) %>%
#     #select the extremes and take mean of middle
#     pivot_wider(names_from = eir_col, values_from = c(ca), id_cols = c("sub", "ZS","setting", fut_cols, "seed", "age")) %>%
#     group_by(across(c("sub", "ZS","setting", "age", fut_cols))) %>% 
#     dplyr::summarise(ca.mean = mean(get(EIR_names[2]))
#                      , ca.sup = max(get(EIR_names[3]), get(EIR_names[2]), get(EIR_names[1]))
#                      , ca.inf = min(get(EIR_names[3]), get(EIR_names[2]), get(EIR_names[1]))) 
#   
#   if (level_aggr == "sub"){
#     aggrDF = subSims
#   }
#   if (level_aggr == "setting"){ 
#     #aggregate at setting level by summing all cases averted
#     aggrDF = subSims %>% group_by(across(c("setting", age, fut_cols))) %>%
#       dplyr::summarise(ca.tot.mean = sum(ca.mean)
#                        , ca.tot.sup = sum(ca.sup)
#                        , ca.tot.inf = sum(ca.inf)) 
#   }
#   if (level_aggr == "ZS"){ 
#     #aggregate at ZS level by summing all cases averted
#     aggrDF = subSims %>% group_by(across(c("ZS", age, fut_cols))) %>%
#       dplyr::summarise(ca.tot.mean = sum(ca.mean)
#                        , ca.tot.sup = sum(ca.sup)
#                        , ca.tot.inf = sum(ca.inf)) 
#   }
#   if(level_aggr == "national"){
#     #aggregate at setting level by summing all cases averted
#     aggrDF = subSims %>% group_by(across(c("age", fut_cols))) %>%
#       dplyr::summarise(ca.tot.mean = sum(ca.mean)
#                        , ca.tot.sup = sum(ca.sup)
#                        , ca.tot.inf = sum(ca.inf)) 
#   }
#   return(aggrDF)
# }

percentReductionPR.acrossScenarios <- function(allSims
                                               , pr_col = "PR"
                                               , level_aggr = "setting"
                                               , pop_col = "totPop"
                                               , eir_col = "EIR"
                                               , EIR_names = c("low","middle","high")
                                               , fut_cols = "fut"
                                               , comparison_year = 2025
                                               , counterfactual = "BaU"
                                               , id_cols = c("sub", "setting", "seed", "year", "age", pop_col, fut_cols)){

  simsSub =  allSims %>% pivot_wider(names_from = eir_col
                                     , values_from = pr_col
                                     , id_cols = id_cols
                                     , names_expand = TRUE)

  if (level_aggr == "setting"){
    aggrDF = simsSub %>% group_by(across(c("setting", "year", fut_cols, "seed", "age"))) %>%
      dplyr::summarise(PR_mean = weighted.mean(get(EIR_names[2]), get(pop_col))
                       , PR_inf = weighted.mean(get(EIR_names[1]), get(pop_col))
                       , PR_sup = weighted.mean(get(EIR_names[3]), get(pop_col))) %>%
      filter(year %in% c(comparison_year)) %>%
      group_by(setting, seed, age) %>%
      mutate(diff.mean= 100*(1-PR_mean/PR_mean[get(fut_cols) == counterfactual]),
             diff.inf= 100*(1-PR_inf/PR_inf[get(fut_cols) == counterfactual]),
             diff.sup= 100*(1-PR_sup/PR_sup[get(fut_cols) == counterfactual])) %>%
      group_by(across(c("setting", fut_cols, 'age'))) %>%
      summarise(diff.mean.Aggr=mean(diff.mean),
                diff.inf.Aggr=min(diff.inf, diff.mean, diff.sup),
                diff.sup.Aggr=max(diff.inf, diff.mean, diff.sup))
  }

  if (level_aggr == "national"){
    aggrDF = simsSub %>% group_by(across(c("year", fut_cols, "seed", "age"))) %>%
      dplyr::summarise(PR_mean = weighted.mean(get(EIR_names[2]), get(pop_col))
                       , PR_inf = weighted.mean(get(EIR_names[1]), get(pop_col))
                       , PR_sup = weighted.mean(get(EIR_names[3]), get(pop_col))) %>%
      filter(year %in% c(comparison_year)) %>%
      group_by(seed, age) %>%
      mutate(diff.mean= 100*(1-PR_mean/PR_mean[get(fut_cols) == counterfactual]),
             diff.inf= 100*(1-PR_inf/PR_inf[get(fut_cols) == counterfactual]),
             diff.sup= 100*(1-PR_sup/PR_sup[get(fut_cols) == counterfactual])) %>%
      group_by(across(c(fut_cols, 'age'))) %>%
      summarise(diff.mean.Aggr=mean(diff.mean),
                diff.inf.Aggr=min(diff.inf, diff.mean, diff.sup),
                diff.sup.Aggr=max(diff.inf, diff.mean, diff.sup))
  }
  return(aggrDF)
}
```

```{r LOAD DATA AND DEFINE SCENARIOS}

setwd(dirname(rstudioapi::getSourceEditorContext()$path))

averted_cases <- readRDS("./Data_prio/averted_popDPAF.rds")

ZScommune <- readRDS("./Data_prio/correpondence_ZS_commune.rds")

# allow for Bembereke and Sinende to switch from PMC pilot to SMC in 2026
eligible <- readRDS("./Data_prio/eligible_communes.rds") %>%
  mutate(SMC=ifelse(sub%in%c("bembereke","sinende"),TRUE,SMC))

avertedZS <- readRDS("./Data_prio/averted_ZS_popDPAF.rds") %>%
  left_join(eligible %>% select(-sub) %>% distinct())

avertedsub <- readRDS("./Data_prio/averted_sub_popDPAF.rds") %>%
  left_join(eligible)

avertedZS_PBOstandard <- readRDS("./Data_prio/averted_PBOtostandard2026_ZS_popDPAF.rds") %>%
  left_join(eligible %>% select(-sub) %>% distinct())

avertedsub_PBOstandard <- readRDS("./Data_prio/averted_PBOtostandard2026_sub_popDPAF.rds") %>%
  left_join(eligible)

pop <- readRDS("./Data_prio/popDPAF.rds")

cases <- readRDS("./Data_prio/simple_severe_popDPAF.rds")

PfPR <- readRDS("./Data_prio/PfPR0to5.rds")

#Admin2 <- file.path("./Data_prio/shapefiles/communes.shp") %>% readOGR(verbose = FALSE)
#New:
Admin2 <- sf::st_read(
  "./Data_prio/shapefiles/communes.shp",
  quiet = TRUE
)

#this things to make shapefile lighter
#Admin2_rg = rgeos::gSimplify(Admin2, tol = 0.02, topologyPreserve = TRUE)
#New:
#Admin2_rg = sf::st_simplify(Admin2, dTolerance = 0.02, preserveTopology = TRUE)
# Desativar s2, corrigir geometria e simplificar
sf::sf_use_s2(FALSE)
Admin2_valid <- sf::st_make_valid(Admin2)
Admin2_rg <- sf::st_simplify(Admin2_valid, dTolerance = 0.02, preserveTopology = TRUE)
sf::sf_use_s2(TRUE)
#Admin2_df <- Admin2@data %>% mutate(sub=tolower(NAME1_),
#                                    Admin1=case_when(Admn1_N=="Kouffo" ~ "Couffo",
#                                                     Admn1_N=="Atakora" ~ "Atacora",
#                                                     Admn1_N=="OuÃ©mÃ©" ~ "Oueme",
 #                                                    TRUE ~ Admn1_N))
 #New:
 Admin2_df <- Admin2 %>%
  mutate( sub = tolower(NAME1_), Admin1 = case_when(
      Admn1_N == "Kouffo"  ~ "Couffo",
      Admn1_N == "Atacora" ~ "Atacora",
      Admn1_N == "Ouémé"   ~ "Oueme",
      TRUE ~ Admn1_N
    )
)

#Admin2_gSimplify <- sp::SpatialPolygonsDataFrame(Admin2_rg, Admin2_df)
#New:
# Admin2_rg já é um objeto sf completo com dados e geometria
# Não precisa fazer nada mais!
# Se precisar renomear:
Admin2_gSimplify <- Admin2_rg

#AdminZS <- file.path("./Data_prio/shapefiles/BEN_ZS_dissolved_Shp_BEN.shp") %>% readOGR(verbose = FALSE)
#New:
AdminZS <- sf::st_read(
  "./Data_prio/shapefiles/BEN_ZS_dissolved_Shp_BEN.shp",
  quiet = TRUE
)

#to merge ZS of Cotonou
AdminZS$ZS <- ifelse(grepl("COTONOU",AdminZS$ZS),"COTONOU",AdminZS$ZS)
#AdminZS_df <- AdminZS@data %>% mutate(Admin1=case_when(NEW_DEPT=="Ou?m?" ~ "Oueme",
#                                                     TRUE ~ NEW_DEPT)) %>% distinct(Admin1,ZS)
#New:
AdminZS_df <- AdminZS %>% 
  st_drop_geometry() %>%  # Remove a geometria, deixa só os dados
  mutate(Admin1 = case_when(
    NEW_DEPT == "Ouémé" ~ "Oueme",
    TRUE ~ NEW_DEPT
  )) %>% 
  dplyr::select(Admin1, ZS)

#this things to make shapefile lighter
#AdminZS_COT <- rgeos::gUnaryUnion(AdminZS, id = AdminZS$ZS)
#AdminZS_rg = rgeos::gSimplify(AdminZS_COT, tol = 0.02, topologyPreserve = TRUE)
#AdminZS_gSimplify <- sp::SpatialPolygonsDataFrame(AdminZS_COT, AdminZS_df,match.ID = "ZS")

#AdminZS_gSimplify@data <- AdminZS_gSimplify@data %>%
#  rename(ZS_CHAI="ZS") %>%
#  left_join(eligible %>% select(ZS_CHAI,ZS,nameZS) %>% distinct())

#New:
# Simplificar shapefile com sf
sf::sf_use_s2(FALSE)

# Corrigir geometrias inválidas
AdminZS_valid <- sf::st_make_valid(AdminZS)

# Unir geometrias por ZS (equivalente ao gUnaryUnion)
AdminZS_COT <- AdminZS_valid %>%
  group_by(ZS) %>%
  summarise(geometry = st_union(geometry), .groups = 'drop')

# Simplificar (equivalente ao gSimplify)
AdminZS_rg <- sf::st_simplify(AdminZS_COT, dTolerance = 0.02, preserveTopology = TRUE)

sf::sf_use_s2(TRUE)

# Adicionar os dados do AdminZS_df
AdminZS_gSimplify <- AdminZS_rg %>%
  left_join(AdminZS_df, by = "ZS")

# Renomear e fazer join com eligible
AdminZS_gSimplify <- AdminZS_gSimplify %>%
  rename(ZS_CHAI = ZS) %>%
  left_join(eligible %>% select(ZS_CHAI, ZS, nameZS) %>% distinct(), 
            by = "ZS_CHAI")
#futrs <- readRDS("./Data_prio/futrs.rds")

```

```{r, eval=FALSE}
table <- data.frame(commune=c("cotonou","dassa","ze"),
                    plan=c("MIILD","MIILD+PID","PBO"),
                    `MIILD 2026`=c("MIILD","MIILD","PBO"),
                    RTS=FALSE,
                    SMC=FALSE,
                    PMC=FALSE)
# 
# renderRHandsontable({
#     rhandsontable(table)
#   })

output = renderDataTable(table %>% datatable(editable = "cell"))

output

```

Hypothèses
=====================================

Inputs {.sidebar}
-------------------------------------

#### Coûts unitaires (en €)

##### Lutte anti-vectorielle

Coûts par personne protégée

```{r}
numericInput("cost_standard",
               "Moustiquaire standard",
              value=1.89)

numericInput("cost_PBO",
               "Moustiquaire bi-traitée",
              value=2.49)

numericInput("cost_IRS",
               "PID",
              value=3.72)

```

##### Prévention chez les enfants

Coûts par enfant complètement protégé

```{r}
numericInput("cost_SMC",
               "CPS",
              value=6.02)

numericInput("cost_PMC",
               "CPP",
              value=2.5)

numericInput("cost_RTSS",
               "vaccin",
              value=50)

```

##### Gestion des cas

```{r}
numericInput("cost_base",
               "Paquet de base",
              value=0.9)
```

column {data-width=400}
-------------------------------------

#### Interventions
  
Les interventions courantes (mêmes moustiquaires en 2026 qu'en 2023, CPS dans l'Alibori et l'Atacora, projets pilotes de CPP) ont été simulées jusqu'en 2026. Les interventions suivantes peuvent être ajoutées ou substituées aux interventions courantes :

* Moustiquaires standard ou bi-traitées en 2026, avec une couverture identique à celle mesurée par département lors de l'enquête EDSB-V et une demi-vie de deux ans
* CPS (sauf dans les communes participant déjà au projet pilote de CPP) de juillet à octobre à partir de 2024 avec une couverture de 80% 
* CPP (sauf dans l'Alibori et l'Atacora qui bénéficient déjà de la CPS) à partir de janvier 2024 avec une couverture de 80% 
* vaccin RTS,S à partir de janvier 2024 avec une couverture de 80% pour les trois premières doses, et 64% pour la quatrième
* PID en avril à partir de 2024 avec une couverture de 80%.

#### Population

La population utilisée provient des prévisions de la DPAF On fait aussi l'hypothèse que dans chaque commune :

* 15.2% de la population a entre 3 et 59 mois et est éligible à la CPS
* 4.6% de la population a entre 0 et 29 mois et est éligible à la CPP
* 3.5% de la population a moins de 18 mois.

Impact
=====================================

Inputs {.sidebar}
-------------------------------------

**Interventions**

```{r}
actionButton("restore_strat_dis", "Voir la stratification")

observeEvent(input$restore_strat_dis, {
  updateSelectizeInput(session, "dis_select_standard", selected = NULL,choices=unique(averted_cases$sub))
  updateSelectizeInput(session, "dis_select_smc", selected = eligible %>% filter(SMC) %>% pull(sub))
  updateSelectizeInput(session, "dis_select_pmc", selected = setdiff(eligible %>% filter(PMC) %>% pull(sub),c("bembereke","sinende")))
  updateSelectizeInput(session, "dis_select_rtss", selected = eligible %>% filter(RTSS) %>% pull(sub))
  updateSelectizeInput(session, "dis_select_irs", selected = eligible %>% filter(IRS) %>% pull(sub))
})
```


_La CPS et la CPP sont mutuellement exclusives._

_Toutes les communes ne recevant pas de moustiquaires standard en 2026 recevront des moustiquaires bi-traitées._

```{r}
standard_plan <- averted_cases %>% filter(scenario=="plan",nets2026=="standard") %>% pull(sub)

smc_plan <- averted_cases %>% filter(scenario=="plan",SMC) %>% pull(sub)

pmc_plan <- averted_cases %>% filter(scenario=="plan",PMC) %>% pull(sub)

selectizeInput("dis_select_standard",
               "Moustiquaires standard en 2026",
               unique(averted_cases$sub),
               selected = standard_plan,
               multiple = TRUE,
               options = NULL)

selectizeInput("dis_select_smc", "CPS", eligible %>% filter(SMC) %>% pull(sub), selected = smc_plan, multiple = TRUE,
               options = NULL)

selectizeInput("dis_select_pmc", "CPP", eligible %>% filter(PMC) %>% pull(sub) ,selected = pmc_plan, multiple = TRUE,
               options = NULL)

# show possibility to select districts for PMC that have not been selected for SMC
# observeEvent(input$dis_select_smc, {
# 
#   pmc_dist = averted_cases %>% filter(!(sub %in% input$dis_select_smc)) %>% pull(sub) %>% unique()
#   
#   updateSelectizeInput(inputId = "dis_select_pmc", choices = pmc_dist, selected = c())
#   
# 
# })

selectizeInput("dis_select_rtss", "vaccin", eligible %>% filter(RTSS) %>% pull(sub), selected = NULL, multiple = TRUE,
               options = NULL)

selectizeInput("dis_select_irs", "PID", eligible %>% filter(IRS) %>% pull(sub), selected = NULL, multiple = TRUE,
               options = NULL)

```

```{r}
actionButton("restore_plan_dis", "Voir les interventions courantes")

observeEvent(input$restore_plan_dis, {
  updateSelectizeInput(session, "dis_select_standard", selected = standard_plan)
  updateSelectizeInput(session, "dis_select_smc", selected = smc_plan)
  updateSelectizeInput(session, "dis_select_pmc", selected = pmc_plan)
  updateSelectizeInput(session, "dis_select_rtss", selected = NULL,choices=unique(averted_cases$sub))
  updateSelectizeInput(session, "dis_select_irs", selected = NULL,choices=unique(averted_cases$sub))
})

```


column {data-width=400}
-------------------------------------

### Interventions sélectionnées

```{r plot map of selected stratification}
createPlanSelect <- function(dis_select_standard,dis_select_smc, dis_select_pmc, dis_select_rtss, dis_select_irs){
  plansSelected = data.frame(sub = unique(averted_cases$sub)
                             , nets2026 = "PBO/IG2"
                             , SMC = FALSE
                             , PMC = FALSE
                             , RTSS = FALSE
                             , IRS = FALSE
                             , scenLabel = "bi-traitées")
  
  plansSelected$nets2026[plansSelected$sub %in% dis_select_standard] = "standard"
  plansSelected$SMC[plansSelected$sub %in% dis_select_smc] = TRUE
  plansSelected$PMC[plansSelected$sub %in% dis_select_pmc] = TRUE
  plansSelected$RTSS[plansSelected$sub %in% dis_select_rtss] = TRUE
  plansSelected$IRS[plansSelected$sub %in% dis_select_irs] = TRUE

  plansSelected = plansSelected %>%
    mutate(scenLabel = case_when(nets2026=="PBO/IG2"& !SMC & !PMC & !RTSS & !IRS ~ "Moustiquaires bi-traitées",
                                 nets2026=="PBO/IG2"& SMC & !PMC & !RTSS & !IRS ~ "Moustiquaires bi-traitées + CPS",
                                 nets2026=="PBO/IG2" & !SMC & PMC & !RTSS & !IRS ~ "Moustiquaires bi-traitées + CPP",
                                 nets2026=="PBO/IG2" & !SMC & !PMC & RTSS & !IRS  ~ "Moustiquaires bi-traitées + vaccin",
                                 nets2026=="PBO/IG2" & !SMC & !PMC & !RTSS & IRS ~ "Moustiquaires bi-traitées + PID",
                                 nets2026=="PBO/IG2" & SMC & !PMC & RTSS & !IRS ~ "Moustiquaires bi-traitées + CPS + vaccin",
                                 nets2026=="PBO/IG2" & SMC & !PMC & !RTSS & IRS ~ "Moustiquaires bi-traitées + CPS + PID",
                                 nets2026=="PBO/IG2" & !SMC & PMC & RTSS & !IRS ~ "Moustiquaires bi-traitées + CPP + vaccin",
                                 nets2026=="PBO/IG2" & !SMC & PMC & !RTSS & IRS ~ "Moustiquaires bi-traitées + CPP + PID",
                                 nets2026=="PBO/IG2" & !SMC & !PMC & RTSS & IRS ~ "Moustiquaires bi-traitées + vaccin + PID",
                                 nets2026=="PBO/IG2" & SMC & !PMC & RTSS & IRS ~ "Moustiquaires bi-traitées + CPS + vaccin + PID",
                                 nets2026=="PBO/IG2" & !SMC & PMC & RTSS & IRS ~ "Moustiquaires bi-traitées + CPP + vaccin + PID",

                                 ## standard nets
                                 nets2026=="standard"& !SMC & !PMC & !RTSS & !IRS ~ "Moustiquaires standard",
                                 nets2026=="standard"& SMC & !PMC & !RTSS & !IRS ~ "Moustiquaires standard + CPS",
                                 nets2026=="standard" & !SMC & PMC & !RTSS & !IRS ~ "Moustiquaires standard + CPP",
                                 nets2026=="standard" & !SMC & !PMC & RTSS & !IRS  ~ "Moustiquaires standard + vaccin",
                                 nets2026=="standard" & !SMC & !PMC & !RTSS & IRS ~ "Moustiquaires standard + PID",
                                 nets2026=="standard" & SMC & !PMC & RTSS & !IRS ~ "Moustiquaires standard + CPS + vaccin",
                                 nets2026=="standard" & SMC & !PMC & !RTSS & IRS ~ "Moustiquaires standard + CPS + PID",
                                 nets2026=="standard" & !SMC & PMC & RTSS & !IRS ~ "Moustiquaires standard + CPP + vaccin",
                                 nets2026=="standard" & !SMC & PMC & !RTSS & IRS ~ "Moustiquaires standard + CPP + PID",
                                 nets2026=="standard" & !SMC & !PMC & RTSS & IRS ~ "Moustiquaires standard + vaccin + PID",
                                 nets2026=="standard" & SMC & !PMC & RTSS & IRS ~ "Moustiquaires standard + CPS + vaccin + PID",
                                 nets2026=="standard" & !SMC & PMC & RTSS & IRS ~ "Moustiquaires standard + CPP + vaccin + PID",
    ))
  return(plansSelected)
  
}

plansSelectedMap = reactive({
  plansSelected = createPlanSelect(input$dis_select_standard,input$dis_select_smc, input$dis_select_pmc, input$dis_select_rtss, input$dis_select_irs)
  plansSelectedMap = sp::merge(Admin2_gSimplify, plansSelected, by = "sub")
  return(plansSelectedMap)
})

# plansSelected = reactive({
#   plansSelected = createPlanSelect(input$dis_select_standard,input$dis_select_smc, input$dis_select_pmc, input$dis_select_rtss, input$dis_select_irs)
#   return(plansSelected)
# })

# renderTable({
#   plansSelected()
# })

# plansSelected = createPlanSelect(standard_plan,smc_plan, pmc_plan, unique(averted_cases$sub), unique(averted_cases$sub))
# plansSelectedMap = sp::merge(Admin2_gSimplify, plansSelected, by = "sub")

#create color palette
scenLabels = c("Moustiquaires bi-traitées"
               ,"Moustiquaires bi-traitées + CPS"
               ,"Moustiquaires bi-traitées + CPP"
               ,"Moustiquaires bi-traitées + vaccin"
               ,"Moustiquaires bi-traitées + CPS + vaccin"
               ,"Moustiquaires bi-traitées + CPP + vaccin"
               ,"Moustiquaires bi-traitées + PID"
               ,"Moustiquaires bi-traitées + CPS + PID"
               ,"Moustiquaires bi-traitées + CPP + PID"
               ,"Moustiquaires bi-traitées + vaccin + PID"
               ,"Moustiquaires bi-traitées + CPS + vaccin + PID"
               ,"Moustiquaires bi-traitées + CPP + vaccin + PID"
               ,"Moustiquaires standard"
               ,"Moustiquaires standard + CPS"
               ,"Moustiquaires standard + CPP"
               ,"Moustiquaires standard + vaccin"
               ,"Moustiquaires standard + CPS + vaccin"
               ,"Moustiquaires standard + CPP + vaccin"
               ,"Moustiquaires standard + PID"
               ,"Moustiquaires standard + CPS + PID"
               ,"Moustiquaires standard + CPP + PID"
               ,"Moustiquaires standard + vaccin + PID"
               ,"Moustiquaires standard + CPS + vaccin + PID"
               ,"Moustiquaires standard + CPP + vaccin + PID")

palScenLabels <- colorFactor(
palette = c("snow3"
            ,"#d11149"
            ,"#f17105"
            
            ,"#6610f2"
            ,"#1d3557"
            ,"#3a86ff"

            ,"#e6c229"
            ,"#6d4c3d"
            ,"#400406"
            
            ,"#ee6055" 
            ,"#2c6e49"
            ,"#16db65"
            
            ,"snow2"
            ,"#ff99c8"
            ,"#fec89a"
            
            ,"#e4c1f9"
            ,"#809bce"
            ,"#a9def9"
            
            , "#fcf6bd"
            , "#a9927d"
            , "#754043"
            
            , "#ff9b85"
            , "#25a18e"
            , "#a1fcdf"),
level = scenLabels)

renderLeaflet({
   leaflet() %>%
   addProviderTiles(providers$CartoDB) %>%
   addPolygons(#data = sp::merge(Admin2_gSimplify, plansSelected(), by = "sub")
             data = plansSelectedMap()
             , label = ~firstup(sub)
             , group = "nc"
             , color = "white"
             , fillColor =  ~palScenLabels(scenLabel)
             , opacity = 1
             , fillOpacity = 1
             , weight = 1
             ,  popup = paste0(firstup(plansSelectedMap()$sub), " (", plansSelectedMap()$Admin1, ")"
                            ,"<br> <b> Interventions: </b>", plansSelectedMap()$scenLabel
                                             )) %>%
  addResetMapButton()%>%
  addSearchFeatures(
   targetGroups  = "nc",
   options = searchFeaturesOptions(zoom = 5, openPopup = TRUE)) %>%
    addLegend("topright"
                             , pal = palScenLabels, values = unique(plansSelectedMap()$scenLabel)
                             , title = "Interventions"
                             , opacity = 1
                             )
  
}
)

```

### Coût total

```{r}
createTargetPop = function(scen.df){
  scen.df <- scen.df %>% ungroup()
  pop_ITNstandard <- scen.df %>% filter(year==2026,nets2026=="standard") %>% summarise(pop_All=sum(pop_All)) %>% pull(pop_All)
  pop_ITNPBO <- scen.df %>%
    filter(year==2026,nets2026=="PBO/IG2") %>% summarise(pop_All=sum(pop_All)) %>% pull(pop_All)
  pop_IRS <- scen.df %>%
    filter(year %in% 2024:2026,IRS) %>%
    summarise(pop_All=sum(pop_All)) %>% pull(pop_All)
  #15.2% eligible to SMC (INSTAD)
  pop_SMC <- scen.df %>%
    filter(year %in% 2024:2026,SMC) %>%
    summarise(pop_All=sum(pop_All)*.152) %>% pull(pop_All)
  #4.6% of pop is eligible to PMC (INSTAD)
    pop_PMC <- scen.df %>%
    filter(year %in% 2024:2026,PMC) %>%
    summarise(pop_All=sum(pop_All)*.046) %>% pull(pop_All)
  #3.5% of pop is less than 1.5 years old (my imagination)
    pop_RTSS <- scen.df %>%
    filter(year %in% 2024:2026,RTSS) %>%
    summarise(pop_All=sum(pop_All)*.035) %>% pull(pop_All)
    pop_base <- scen.df %>%
    filter(year %in% 2024:2026) %>%
    summarise(pop_All=sum(pop_All)) %>% pull(pop_All)
  return(list("ITN"=round(pop_ITNstandard),
              "PBO"=round(pop_ITNPBO),
              "IRS"=round(pop_IRS),
              "SMC"=round(pop_SMC),
              "PMC"=round(pop_PMC),
              "RTSS"=round(pop_RTSS),
              "base"=round(pop_base)))
}

# createTargetPop(right_join(averted_cases %>% filter(scenario=="IRS_PBO2026"), pop) %>% filter(scenario=="IRS_PBO2026"))

PopTargetCost = reactive({
  plansSelected = createPlanSelect(input$dis_select_standard,input$dis_select_smc, input$dis_select_pmc, input$dis_select_rtss, input$dis_select_irs)
  selectScen = right_join(plansSelected, pop)
  PopTarget=createTargetPop(selectScen)
  SelectPopTarget=data.frame(
    Intervention=c("Moustiquaires standard","Moustiquaires bi-traitées","CPS","CPP","vaccin","PID","Paquet de base","Total"),
                             Population=c(PopTarget$ITN,PopTarget$PBO,PopTarget$SMC,PopTarget$PMC,PopTarget$RTSS,PopTarget$IRS,PopTarget$base,0),
                             Cout=c(input$cost_standard,input$cost_PBO,input$cost_SMC,input$cost_PMC,input$cost_RTSS,input$cost_IRS,input$cost_base,0))
  
  SelectPopTarget <- SelectPopTarget %>%
    mutate(`Coût total (en €)`=round(Population*Cout)) %>%
    rename(`Population ciblée`="Population",
           `Coût unitaire (en €)`="Cout")
  
  SelectPopTarget[dim(SelectPopTarget)[1],] <- c("Total","","",sum(SelectPopTarget$`Coût total`))
  
  SelectPopTarget <-  SelectPopTarget %>%
    mutate(across(c(`Population ciblée`,`Coût total (en €)`),~prettyNum(., big.mark = " ", preserve.width = "none")))
  SelectPopTarget$`Population ciblée`[dim(SelectPopTarget)[1]]<-""
  
  return(SelectPopTarget)
})

renderTable({
  PopTargetCost()
},align="r")

```

column {data-width=400}
-------------------------------------

```{r}
actionButton("go", "Cliquer ici pour estimer l'impact des interventions sélectionnées")
```


### Evolution de la prévalence

```{r}

eligible_tweaked <- eligible %>%
  mutate(PMC=ifelse(sub%in%c("bembereke","sinende"),FALSE,PMC))

BaUPf <- PfPR %>% filter(scenario=="plan") %>% select(-scenario) %>%
  mutate(plan="Interventions courantes")
stratificationPf <- PfPR %>%
  right_join(eligible_tweaked) %>%
  filter(nets2026=="PBO/IG2") %>%
  select(-c(scenario,contains("ZS"),PBO)) %>% distinct() %>%
  mutate(plan="Stratification")

# percentReductionPR.acrossScenarios(rbind(BaUPf,stratificationPf)
#                                                , pr_col = "PR"
#                                                , level_aggr = "national"
#                                                , pop_col = "pop"
#                                                , eir_col = "EIR_type"
#                                                , EIR_names = c("lower","middle","upper")
#                                                , fut_cols = "plan"
#                                                , comparison_year = 2026
#                                                , counterfactual = "Interventions courantes")

plansSelectedBaULine = eventReactive(input$go,{
  selectedPf <- createPlanSelect(input$dis_select_standard,input$dis_select_smc, input$dis_select_pmc, input$dis_select_rtss, input$dis_select_irs) %>%
    left_join(PfPR %>% select(-scenario) %>% distinct()) %>%
    mutate(plan="Interventions sélectionnées")
  Pf_BEN <- computeAggrTimeSeriesPR(rbind(selectedPf %>% select(-scenLabel),BaUPf,stratificationPf)
                                    , pr_col = "PR"
                                    , level_aggr = "national"
                                    , pop_col = "pop"
                                    , eir_col = "EIR_type"
                                    , EIR_names = c("lower","middle","upper")
                                    , fut_cols = "plan")[[2]] %>%
    rename(PR_mean = ind_mean, PR_inf = ind_inf, PR_sup = ind_sup)
  g<-ggplot(Pf_BEN %>% filter(year>=2022),
            aes(x=year,y=PR_mean,ymin=PR_inf,ymax=PR_sup,color=plan,fill=plan,group=plan,
                text=paste0(round(PR_mean*100),"%"," (",round(PR_inf*100)," - ",round(PR_sup*100),")")))+
    geom_ribbon(alpha=.5)+
    geom_line()+
    labs(x="Année",y="Prévalence chez les enfants de moins de 5 ans",color="",fill="")+
    scale_y_continuous(labels=scales::percent)+
    scale_color_manual(values=c("grey","red","#046C9A"))+
    scale_fill_manual(values=c("grey","red","#046C9A"))+
    theme_minimal()

  p<-ggplotly(g,tooltip = "text") %>%
    layout(yaxis=list(title=list(font=list(size=10))),
           legend = list(orientation = "h", x = 0.4, y = -0.2))
  return(p)
})


renderPlotly(plansSelectedBaULine())


```
### Total des cas (en milliers)

```{r}
selectScenCases = eventReactive(input$go,{
  plansSelected = createPlanSelect(input$dis_select_standard,input$dis_select_smc, input$dis_select_pmc, input$dis_select_rtss, input$dis_select_irs)
  selectScenCases = left_join(plansSelected, cases %>%
  select(-scenario) %>% distinct()) %>%
    filter(year>2022) %>%
    group_by(year) %>%
    summarise(across(c("tSimple.mean","tSevere.mean"),~round(sum(.,na.rm=TRUE)/10^3))) %>%
    mutate(`Total des cas`=tSevere.mean+tSimple.mean) %>%
    mutate(across(year:`Total des cas`,as.integer)) %>%
    rename(`Année`="year",`Cas simples`="tSimple.mean",`Cas graves`="tSevere.mean") %>%
    mutate(across(`Cas simples`:`Total des cas`,~prettyNum(., big.mark = " ", preserve.width = "none")))
  return(selectScenCases)
})

renderTable({
  selectScenCases()
},align="r")

```

### Impact par rapport aux interventions courantes (mêmes moustiquaires en 2026 qu'en 2023, CPS dans l'Alibori et l'Atacora, projets pilotes de CPP)

On présente les cas et décès tous âges confondus additionnellement évités entre 2024 et 2026.

##### Cas évités (en milliers)

```{r}
# sum(left_join(createPlanSelect(unique(averted_cases$sub),smc_plan,pmc_plan,c(),c()),averted_cases %>%
#   select(-scenario) %>% distinct()) %>%
#   pull(ca.mean))

selectScen = eventReactive(input$go,{
  plansSelected = createPlanSelect(input$dis_select_standard,input$dis_select_smc, input$dis_select_pmc, input$dis_select_rtss, input$dis_select_irs)
  selectScen = left_join(plansSelected, averted_cases %>%
  select(-scenario) %>% distinct())
  return(selectScen)
})

renderText({
  paste0(prettyNum(round(sum(selectScen()$ca.mean)/10^3),big.mark = " ", preserve.width = "none"), " (", prettyNum(round(sum(selectScen()$ca.inf)/10^3), big.mark = " ", preserve.width = "none"), " - ", prettyNum(round(sum(selectScen()$ca.sup)/10^3), big.mark = " ", preserve.width = "none"), ")")
})
```

###### Dont cas graves (en milliers)

```{r}
# sum(left_join(createPlanSelect(unique(averted_cases$sub),smc_plan,pmc_plan,c(),c()),averted_cases %>%
#   select(-scenario) %>% distinct()) %>%
#   pull(ca.mean))

selectScen = eventReactive(input$go,{
  plansSelected = createPlanSelect(input$dis_select_standard,input$dis_select_smc, input$dis_select_pmc, input$dis_select_rtss, input$dis_select_irs)
  selectScen = left_join(plansSelected, averted_cases %>%
  select(-scenario) %>% distinct())
  return(selectScen)
})

renderText({
  paste0(prettyNum(round(sum(selectScen()$severea.mean)/10^3), big.mark = " ", preserve.width = "none"), " (", prettyNum(round(sum(selectScen()$severea.inf)/10^3), big.mark = " ", preserve.width = "none"), " - ", prettyNum(round(sum(selectScen()$severea.sup)/10^3), big.mark = " ", preserve.width = "none"), ")")
})
```

##### Décès évités

```{r}
renderText({
  paste0(prettyNum(round(sum(selectScen()$da.mean)), big.mark = " ", preserve.width = "none"), " (", prettyNum(round(sum(selectScen()$da.inf)), big.mark = " ", preserve.width = "none"), " - ", prettyNum(round(sum(selectScen()$da.sup)), big.mark = " ", preserve.width = "none"), ")")
})
```

Optimisation par intervention
=====================================

Inputs {.sidebar}
-------------------------------------

```{r}
radioButtons("level_input", label = "Echelon administratif",
            choices = c("Zones sanitaires", "Communes"),
            selected="Zones sanitaires")
```

```{r}
radioButtons("int_input", label = "Intervention",
            choices = c("CPS", "CPP","vaccin","Moustiquaires bi-traitées","PID"),
            selected="CPP")

 # conditionalPanel(
 #             condition = "input.int_input == 'Moustiquaires bi-traitées'", 
 #             "Hypothèse de résistance"
 #                            )
 # 
 # conditionalPanel(
 #             condition = "input.int_input == 'Moustiquaires bi-traitées'", 
 #             selectInput("resistance","",
 #              list("Dans tous le pays", "Uniquement dans les communes confirmées")
 #                            ))
```

```{r}
radioButtons("ind_input", label = "Indicateur",
            choices = c("Tous les cas","Cas simples", "Cas graves", "Décès"),
            selected="Tous les cas")
```

```{r}
radioButtons("age_input", label = "Tranche d'âge",
            choices = c("Tous âges confondus","0 à 1 an","1 à 5 ans", "0 à 5 ans"),
            selected="Tous âges confondus")
```


```{r}
radioButtons("unit_input", label = "Unité",
            choices = c("absolus","par personne protégée", "par euro dépensé"),
            selected="par personne protégée")
```

column {data-width=300}
-------------------------------------

###

```{r indicator averted compared to selected plan in impact tab,eval=FALSE}
dictionary_user_code <- function(level_input,int_input,ind_input,age_input){
  #administrative level
  if(level_input=="Zones sanitaires"){
    level<-"ZS"
  }else{
    level<-"sub"
  }
  if (int_input=="CPS"){
    int<-"SMC"
  }
  if (int_input=="CPP"){
    int<-"PMC"
  }
  if (int_input=="vaccin"){
    int<-"RTSS"
  }
  if (int_input=="PID"){
    int<-"IRS"
  }
  if (int_input=="Moustiquaires bi-traitées"){
    int<-"nets2026"
  }
  # indicator
  if (ind_input=="Tous les cas"){
    ind<-"nTreat"
  }
  if (ind_input=="Cas simples"){
    ind<-"tSimple"
  }
  if (ind_input=="Cas graves"){
    ind<-"tSevere"
  }
  if (ind_input=="Décès"){
    ind<-"expectedDirectDeaths"
  }
    # age group
  article_age<-" chez les "
  if (age_input=="0 à 1 an"){
    age_group<-"0to1"
  }
  if (age_input=="1 à 5 ans"){
    age_group<-"1to5"
  }
  if (age_input=="0 à 5 ans"){
    age_group<-"0to5"
  }
  if (age_input=="Tous âges confondus"){
    age_group<-"All"
  }
return(list(level=level,intervention=int,indicator=ind,age=age_group))
}

reactive({
  chosen<-dictionary_user_code(input$level_input,input$int_input,input$ind_input,input$age_input)
  plansSelected = createPlanSelect(input$dis_select_standard,input$dis_select_smc, input$dis_select_pmc, input$dis_select_rtss, input$dis_select_irs)
  selected_futrs <- futrs %>%
    filter(age==chosen$age) %>%
    right_join(plansSelected %>%
    select(-chosen$intervention[1])) %>%
    mutate(dashboard_scenario=ifelse(get(chosen$intervention),
           "plan_selected_plus_int",
           "plan_selected")) %>%
    group_by(year,seed,EIR_type,sub) %>%
    mutate(count=n()) %>%
    filter(count>1) %>%
    ungroup()
  
  averted <- casesAverted.sumAcrossYears(selected_futrs,
                                                  cases_col = chosen$indicator,
                                                  level_aggr = chosen$level,
                                                  eir_col = "EIR_type",
                                                  EIR_names = c("lower","middle","upper"),
                                                  fut_cols = "dashboard_scenario",
                                                  counterfactual = "plan_selected",
                                                  year_start = 2024,
                                                  year_end = 2026)
    
})
```



```{r}
OrderGeo <- function(level_input,int_input,ind_input,age_input,unit_input){
  #administrative level
  if(level_input=="Zones sanitaires"){
    level<-"ZS"
  }else{
    level<-"sub"
  }
  # intervention
  prop<-1
  if (int_input=="CPS"){
    int<-"SMC"
    prop<-.152
    cost<-input$cost_SMC
  }
  if (int_input=="CPP"){
    int<-"PMC"
    prop<-.046
    cost<-input$cost_PMC
  }
  if (int_input=="vaccin"){
    int<-"RTSS"
    prop<-.035
    cost<-input$cost_RTSS
  }
  if (int_input=="PID"){
    int<-"IRS"
    cost<-input$cost_IRS
  }
  if (int_input=="Moustiquaires bi-traitées"){
    int<-"PBO"
    cost<-input$cost_PBO
  }
  article <- "la"
  if (int_input=="vaccin"){
    article <- "le"
  }
  if (int_input=="Moustiquaires bi-traitées"){
    article <- "les"
  }
  # indicator
  if (ind_input=="Tous les cas"){
    ind<-"c"
  }
  if (ind_input=="Cas simples"){
    ind<-"uncomp"
  }
  if (ind_input=="Cas graves"){
    ind<-"severe"
  }
  if (ind_input=="Décès"){
    ind<-"d"
  }
  # age group
  article_age<-" chez les "
  if (age_input=="0 à 1 an"){
    age_group<-"0to1"
  }
  if (age_input=="1 à 5 ans"){
    age_group<-"1to5"
  }
  if (age_input=="0 à 5 ans"){
    age_group<-"0to5"
  }
  if (age_input=="Tous âges confondus"){
    age_group<-"All"
    article_age<-" "
  }
  
  if (int_input=="Moustiquaires bi-traitées"){
    picked_data <- get(paste0("averted",level,"_PBOstandard"))
    int_input_l <- "moustiquaires bi-traitées en 2026 par rapport aux standard"
  }else{
    picked_data <- get(paste0("averted",level))
    int_input_l <- paste0(int_input," par rapport aux interventions courantes")
  }
  
  if (unit_input=="absolus"){
    data_plot=picked_data %>%
      filter(age==age_group) %>%
      mutate(mean=!!sym(paste0(ind,"a.tot.mean")),
             min=!!sym(paste0(ind,"a.tot.inf")),
             max=!!sym(paste0(ind,"a.tot.sup"))) %>%
      filter(scenario==paste0("plan_",int),!is.na(!!sym(level)),mean>0,!!sym(int))
    
    ylab <- paste0(ind_input,article_age,tolower(age_input),
                         "évités entre 2024 et 2026\npar ",article," ",int_input_l)
    
  }
  if (unit_input=="par personne protégée"){
    data_plot=picked_data %>%
      filter(age==age_group) %>%
      mutate(pop_targeted=prop*pop_All) %>%
      mutate(mean=!!sym(paste0(ind,"a.tot.mean"))/pop_targeted*10^3,
             min=!!sym(paste0(ind,"a.tot.inf"))/pop_targeted*10^3,
             max=!!sym(paste0(ind,"a.tot.sup"))/pop_targeted*10^3) %>%
    filter(scenario==paste0("plan_",int),!is.na(!!sym(level)),mean>0,!!sym(int))
    
    
   ylab=paste0(ind_input,article_age,tolower(age_input),
                         " évités entre 2024 et 2026\npar",article," ",int_input_l,"\n",
                         "pour 1000 personnes ciblées")
    
  }
  if (unit_input=="par euro dépensé"){
    data_plot=picked_data %>%
      filter(age==age_group) %>%
      mutate(pop_targeted=prop*pop_All) %>%
      mutate(cost_total=pop_targeted*cost) %>%
      mutate(mean=!!sym(paste0(ind,"a.tot.mean"))/cost_total*10^3,
             min=!!sym(paste0(ind,"a.tot.inf"))/cost_total*10^3,
             max=!!sym(paste0(ind,"a.tot.sup"))/cost_total*10^3) %>%
    filter(scenario==paste0("plan_",int),!is.na(!!sym(level)),mean>0,!!sym(int))
    
    
   ylab=paste0(ind_input,article_age,tolower(age_input),
                         " évités entre 2024 et 2026\npar",article," ",int_input_l,"\n",
                         "pour 1000 euros")
    
  }
  
  data_plot <- data_plot %>%
    ungroup() %>%
    mutate(rank=rank(-mean))
  b<-floor(max(data_plot$rank)/5)
  data_plot <- data_plot %>%
    mutate(rankbreaks=ceiling(rank/b)) %>%
    mutate(rankbreaks=ifelse(rankbreaks>5,5,rankbreaks))
  
  return(list(d=data_plot,y=ylab,cost=cost,proportion=prop))
}

#OrderGeo("Communes","CPP","Cas graves","0 à 5 ans","absolus")$d


palRanks <- c('#780116','#c32f27','#d8572a','#db7c26','#f7b538')

renderLeaflet({
  result<-OrderGeo(input$level_input,input$int_input,input$ind_input,input$age_input,input$unit_input)$d %>%
    select(-Admin1)
  if(input$level_input=="Communes"){
    ranking <- raster::merge( Admin2_gSimplify, result,
                              by = "sub" )
    leaflet() %>%
      addProviderTiles(providers$CartoDB) %>%
      addPolygons(data = sf::st_as_sf(ranking)
                  , label = ~firstup(sub)
                  , group = "nc"
                  , color = "white"
                  , fillColor =  ~colorFactor(palRanks, domain = NULL,na.color = "lightgrey")(rankbreaks)
                  , opacity = 1
                  , fillOpacity = 1
                  , weight = 1
                  ,  popup = paste0(firstup(ranking$sub), " - "
                                    ,ranking$rank
                  )
      ) %>%
      addResetMapButton()%>%
      addSearchFeatures(
        targetGroups  = "nc",
        options = searchFeaturesOptions(zoom = 5, openPopup = TRUE)) #%>%
    # addLegend("bottomright"
    #                    , pal = palScenLabels, values = unique(plansSelectedMap()$scenLabel)
    #                    , title = "Interventions"
    #                    , opacity = 1
    #                    )
  }else{
    ranking <- raster::merge( AdminZS_gSimplify, result,
                              by = c("ZS","ZS_CHAI","nameZS") )
    leaflet() %>%
      addProviderTiles(providers$CartoDB) %>%
      addPolygons(data = sf::st_as_sf(ranking)
                  , label = ~ZS
                  , group = "nc"
                  , color = "white"
                  , fillColor =  ~colorFactor(palRanks, domain = NULL,na.color = "lightgrey")(rankbreaks)
                  , opacity = 1
                  , fillOpacity = 1
                  , weight = 1
                  ,  popup = paste0(firstup(ranking$nameZS), " : "
                                    ,ranking$rank
                  )
      ) %>%
      addResetMapButton()%>%
      addSearchFeatures(
        targetGroups  = "nc",
        options = searchFeaturesOptions(zoom = 5, openPopup = TRUE))
  }
}
)

```

column {data-width=500}
-------------------------------------
###

```{r}

Barplot = reactive({
  r=OrderGeo(input$level_input,input$int_input,input$ind_input,input$age_input,input$unit_input)
  data_plot <- r$d
  ylab <- r$y
  if(input$level_input=="Zones sanitaires"){
      g<-ggplot(data_plot,
            aes(x=reorder(ZS,-mean),y=mean,ymin=min,ymax=max,
                fill=as.factor(rankbreaks),
                color=as.factor(rankbreaks),
                text=paste0(nameZS,
                            #"<br>Enfants ciblés : ",round(pop_targeted),
                            "<br>",round(mean,2),
                            " (",round(min,2)," - ",round(max,2),")")))+
        labs(x="Zone sanitaire",y=ylab,color="Département",fill="Département")
  }else{
      g<-ggplot(data_plot,
            aes(x=reorder(firstup(sub),-mean),y=mean,ymin=min,ymax=max,
                fill=as.factor(rankbreaks),
                color=as.factor(rankbreaks),
                text=paste0(firstup(sub),
                            #"<br>Enfants ciblés : ",round(pop_targeted),
                            "<br>",round(mean,2),
                            " (",round(min,2)," - ",round(max,2),")")))+
        labs(x="Commune",y=ylab,color="Département",fill="Département")
  }

    g<-g+
      geom_col(alpha=.85)+
    geom_errorbar(width=.3)+
    scale_color_manual(values=palRanks)+
    scale_fill_manual(values=palRanks)+
    theme_minimal()+
    theme(axis.text.x=element_text(angle = 45),legend.position = "none")
  
  p<-ggplotly(g,tooltip = "text") %>%
    layout(yaxis=list(title=list(font=list(size=10))))
  return(p)
})

renderPlotly(Barplot())

```

### Coût cumulé (sans économies d'échelle)

```{r}

BarplotCost = reactive({
  r=OrderGeo(input$level_input,input$int_input,input$ind_input,input$age_input,input$unit_input)
  data_plot <- r$d
  cost <- r$cost
  prop <- r$proportion
  data_cost <- data_plot %>%
    arrange(-mean) %>%
    ungroup() %>%
    mutate(pop_targeted=prop*pop_All) %>%
    mutate(cost_total=pop_targeted*cost) %>%
    mutate(cum_cost=cumsum(cost_total))
  if(input$level_input=="Zones sanitaires"){
  data_cost$ZS_plus <- paste0("+ ",data_cost$ZS)
  data_cost$ZS_plus[1] <- data_cost$ZS[1]
  data_cost$nameZS_plus <- paste0("+ ",data_cost$nameZS)
  data_cost$nameZS_plus[1] <- data_cost$nameZS[1]
  g<-ggplot(data_cost,
            aes(y=reorder(ZS_plus,mean),x=cum_cost/10^6,fill=as.factor(rankbreaks),
                text=paste0(nameZS_plus,
                            #"<br>Enfants ciblés : ",round(pop_targeted),
                            "<br>",prettyNum(round(cum_cost),big.mark = " ", preserve.width = "none"),"€")))+
    labs(y="Zone sanitaire",x="Coût cumulé en millions d'euros",fill="Département")
  }else{
  data_cost$sub_plus <- paste0("+ ",firstup(data_cost$sub))
  data_cost$sub_plus[1] <- firstup(data_cost$sub[1])
  g<-ggplot(data_cost,
            aes(y=reorder(sub_plus,mean),x=cum_cost/10^6,fill=as.factor(rankbreaks),
                text=paste0(sub_plus,
                            #"<br>Enfants ciblés : ",round(pop_targeted),
                            "<br>",prettyNum(round(cum_cost),big.mark = " ", preserve.width = "none"),"€")))+
    labs(y="Commune",x="Coût cumulé en millions d'euros",fill="Département")
  }
    g<-g+geom_col(alpha=.85)+
    scale_fill_manual(values=palRanks)+
    theme_minimal()+
    theme(axis.text.x=element_text(angle = 45),legend.position = "none")
  
  p<-ggplotly(g,tooltip = "text") %>%
    layout(yaxis=list(title=list(font=list(size=10))))
  return(p)
})

renderPlotly(BarplotCost())

```

Optimisation par commune
=====================================

Inputs {.sidebar}
-------------------------------------
```{r}
selectizeInput("opt_commune_input", "Commune", unique(averted_cases$sub), selected = "bassila", multiple = FALSE,
               options = NULL)
```


```{r}
radioButtons("opt_ind_input", label = "Indicateur",
            choices = c("Tous les cas","Cas simples", "Cas graves", "Décès"),
            selected="Tous les cas")
```

```{r}
radioButtons("opt_age_input", label = "Tranche d'âge",
            choices = c("Tous âges confondus","0 à 1 an","1 à 5 ans", "0 à 5 ans"),
            selected="Tous âges confondus")
```


column {data-width=300}
-------------------------------------

###

```{r}
OrderCost <- function(opt_commune_input,opt_ind_input,opt_age_input){
  #administrative level

  # indicator
  if (opt_ind_input=="Tous les cas"){
    ind<-"c"
    ind_legend<-"cas"
  }
  if (opt_ind_input=="Cas simples"){
    ind<-"uncomp"
    ind_legend <- "cas simple"
  }
  if (opt_ind_input=="Cas graves"){
    ind<-"severe"
    ind_legend <- "cas grave"
  }
  if (opt_ind_input=="Décès"){
    ind<-"d"
    ind_legend <- "décès"
  }
  # age group
  article_age<-" chez les "
  if (opt_age_input=="0 à 1 an"){
    age_group<-"0to1"
  }
  if (opt_age_input=="1 à 5 ans"){
    age_group<-"1to5"
  }
  if (opt_age_input=="0 à 5 ans"){
    age_group<-"0to5"
  }
  if (opt_age_input=="Tous âges confondus"){
    age_group<-"All"
    article_age<-" "
  }
  
data_plot=avertedsub %>%
    filter(age==age_group,sub==opt_commune_input) %>%
    mutate(prop=case_when(scenario=="plan_SMC"~.152,
                          scenario=="plan_PMC"~.046,
                          TRUE~1)) %>%
    left_join(pop %>% filter(year==2026) %>% rename(pop_2026="pop_All")) %>%
    mutate(cost=case_when(scenario=="plan_SMC"~input$cost_SMC,
                          scenario=="plan_PMC"~input$cost_PMC,
                          scenario=="plan_IRS"~input$cost_IRS,
                          scenario=="plan_PBO"~(input$cost_PBO-input$cost_standard))) %>%
    mutate(pop_All=ifelse(scenario=="plan_PBO",pop_2026,pop_All)) %>%
    mutate(pop_targeted=prop*pop_All) %>%
    mutate(cost_total=pop_targeted*cost) %>%
    mutate(mean=cost_total/!!sym(paste0(ind,"a.tot.mean")),
           max=cost_total/!!sym(paste0(ind,"a.tot.inf")),
           min=cost_total/!!sym(paste0(ind,"a.tot.sup"))) %>%
    filter(!is.na(mean),mean<Inf)
    
    
   ylab=paste0("Coût d'un ",ind_legend,article_age,tolower(opt_age_input),
                         "\névité entre 2024 et 2026 (en euros)")
  
  return(list(d=data_plot,y=ylab))
}

eligibleSMC <- eligible %>% filter(SMC) %>% pull(sub)
eligiblePMC <- eligible %>% filter(PMC) %>% pull(sub)
eligibleIRS <- eligible %>% filter(IRS) %>% pull(sub)
eligiblePBO <- eligible %>% pull(sub)

BarplotCostPerCase = reactive({
  r<-OrderCost(input$opt_commune_input,input$opt_ind_input,input$opt_age_input)
  data_plot <- r$d %>%
    filter(!(scenario=="plan_SMC"&!sub%in%eligibleSMC)) %>%
    filter(!(scenario=="plan_PMC"&!sub%in%eligiblePMC)) %>%
    filter(!(scenario=="plan_IRS"&!sub%in%eligibleIRS)) %>%
    filter(!(scenario=="plan_PBO"&!sub%in%eligiblePBO)) %>%
    mutate(scenario=case_when(scenario=="plan_SMC"~"CPS",
                              scenario=="plan_PMC"~"CPP",
                              scenario=="plan_IRS"~"PID",
                              scenario=="plan_PBO"~"Moustiquaires bi-traitées",
                              TRUE~"autre"))
  ylab <- r$y
  
  g<-ggplot(data_plot,
       aes(x=reorder(scenario,mean),y=mean,ymin=min,ymax=max,text=paste0(round(mean)," (",round(min)," - ",round(max),")")))+
  geom_col(alpha=.85)+
    geom_errorbar()+
    labs(y=ylab,x="Intervention")+
    theme_minimal()
  
  p<-ggplotly(g,tooltip = "text") %>%
    layout(yaxis=list(title=list(font=list(size=10))))
  return(p)
})

renderPlotly(BarplotCostPerCase())
```


